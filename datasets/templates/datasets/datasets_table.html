<h3>Datasets</h3>

<div class="alert alert-warning" role="alert">
    <strong>Warning:</strong> These data may contain errors.
    <p>
        YeastPhenome.org is running in beta version.
        The data are available for download, but, as of today, we cannot guarantee the absence of errors or code bugs introduced during processing.
        This warning will be removed after all cross-checks and validations have been completed.
        In the meantime, please, be careful when using the data.
    </p>
</div>

{% if datasets %}

{% if template == 'paper' %}
<a href="/{{ template }}s/{{ object.id }}/{{ DOWNLOAD_PREFIX }}_{{ object.pmid }}_datasets_list.txt">Download the list of datasets</a>
{% endif %}

<form action="/data/download/" method="get">
<table id="papersTable" class="tablesorter table table-condensed table-hover" width="100%">

    <thead>
    <td style="text-align: left;"><input type="checkbox" onClick="toggle(this)"></td>
    <th>Papers</th>
    <th>Phenotype</th>
    <th>Conditions</th>
    <th>Collection</th>
    <th>Tested mutants</th>
    <th>Data</th>
    <th>Details</th>
    </thead>

    <tbody>
    {% for dataset in datasets %}
    <tr>
        <td><input id="{{ dataset.id }}" type="checkbox" name="{{ dataset.id }}" class="dataset" {% if not dataset.has_data_in_db %}disabled{% endif %}></td>
        <td class="col-md-2">{{ dataset.paper.link_detail|safe }}</td>
        <td class="col-md-2">{{ dataset.phenotype.link_detail|safe }}</td>
        <td class="col-md-2">{{ dataset.conditionset.link_detail|safe }}</td>
        <td class="col-md-1">{{ dataset.collection }}</td>

        <td class="col-md-2">
            {{ dataset.tested_space|safe }}
            <br><small>
                    {% if dataset.tested_source.html %}
                    {{ dataset.tested_source.html|safe }}
                    {% else %}
                    unavailable
                    {% endif %}
            </small>
        </td>

        <td class="col-md-2">
            {% if dataset.has_data_in_db %}
            <span class="text-success available">{{ dataset.data_available|capfirst }}</span>
                <br><small>
                    {% if dataset.data_source.html %}
                    {{ dataset.data_source.html|safe }}
                    {% else %}
                    unavailable
                    {% endif %}
                </small>
            {% else %}
            <span class="text-muted">{{ dataset.data_available|capfirst }}</span>
            {% endif %}
        </td>

        <td>
            {% spaceless %}
            ~
            {% endspaceless %}

            {% if dataset.has_data_in_db and USER_AUTH %}
            {% spaceless %}
                <span class="glyphicon glyphicon-picture pointer" aria-hidden="true" onclick="popup('https://safe.shinyapps.io/safe_shiny/?datasetid={{ dataset.id }}')"></span>
            {% endspaceless %}
            {% endif %}
        </td>
    </tr>

    <script>
        $(document).ready(function(){
            $(".{{ dataset.id }}").on("hide.bs.collapse", function(){
                $(".collapsible-{{ dataset.id }}").html('<span class="glyphicon glyphicon-eye-open"></span>');
            });
            $(".{{ dataset.id }}").on("show.bs.collapse", function(){
                $(".collapsible-{{ dataset.id }}").html('<span class="glyphicon glyphicon-eye-close"></span>');
            });
        });
    </script>

    {% endfor %}
    </tbody>
</table>

    <button id="dataset_download" type="submit" class="btn btn-default" disabled="true">Download selected datasets</button>

</form>

{% if USER_AUTH %}
{% if template == 'chebi' %}
<a href="/data/conditions/chebi/{{ id }}/{{ DOWNLOAD_PREFIX }}_chebi_{{ id }}_data.txt">Download data matrix</a>
{% else %}
<a href="/data/{{ template }}s/{{ id }}/{{ DOWNLOAD_PREFIX }}_{{ template }}_{{ id }}_data.txt">Download data matrix</a>
{% endif %}
{% endif %}

{% endif %}


<script language="JavaScript">
function toggle(source) {
  checkboxes = document.getElementsByClassName('dataset');
  for(var i=0, n=checkboxes.length;i<n;i++) {
    if(!checkboxes[i].disabled) {
        checkboxes[i].checked = source.checked;
    }
  }
  btn = document.getElementById('dataset_download');
  btn.disabled = !source.checked;
}
</script>

<script language="JavaScript">
var chkbxs = $('tbody .dataset');
chkbxs.change(function () {
    $('#dataset_download').prop('disabled', chkbxs.filter(':checked').length < 1);
});
chkbxs.change();
</script>